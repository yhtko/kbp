
# kintone「進捗スクショ・ギャラリー」プラグイン 要件定義（Codex向け）

## 0. ゴール
- **Trello 的に進捗を回す**（カンバンUIは不要）
- **詳細画面で Ctrl/⌘+V の「貼り付け一発」**でスクショを証拠として保存
- 標準サブテーブルの“業務感”を排し、**軽量なギャラリー（タイムライン）UI**で置換表示
- **最小クリック数・高速表示・壊れにくい**実装

---

## 1. スコープ
- kintone **レコード詳細画面**に専用パネル（ギャラリー）を描画
- 画像の **ペースト / ドラッグ&ドロップ / ファイル選択** で証拠を追加
- 追加時に **自動圧縮（長辺 1600px / JPEG 品質 0.85）**
- 画像は **添付ファイル**として保存し、**履歴（時系列）**で表示
- **メモ（1行）**を付与（インライン編集可）
- クリックで **ライトボックス拡大（新規タブでも可）**
- **編集権限なし**ユーザーは **閲覧のみ**

> UIは**カード演出に凝らない**（サムネ + メモ + 時刻のみ）。

---

## 2. アーキテクチャ選択肢
### A）単一アプリ完結（裏はサブテーブル、UIはカスタム）
- バックエンド：サブテーブル `証拠`（`画像` 添付 / `メモ` 文字列）
- フロント：詳細画面にギャラリーを描画。**標準サブテーブルUIはCSSで非表示**。
- 利点：セットアップ最短。既存アプリを変更最小。
- 欠点：別用途へ横断集計する場合はAPI経由が前提。

### B）子アプリ分離（Evidence アプリ）
- バックエンド：子アプリ `Evidence`（`親レコードID`、`画像`、`メモ`、`作成者`、`作成日時`）
- フロント：親詳細で REST 検索＆ギャラリー表示。追加は子アプリに **新規レコード POST**。
- 利点：大量データでも安定、横断検索/集計が容易。
- 欠点：セットアップ手順が一手多い。

> **初期実装はAを採用**。将来Bに差し替え可能なよう、**データアクセス層を抽象化**。

---

## 3. データモデル（A案）
- サブテーブル名（フィールドコード）：`証拠`
  - 添付ファイル（コード）：`画像`
  - 文字列（複数行 or 1行）（コード）：`メモ`
  - 追加で「作成日時」「作者」を保持したい場合は、メモ内に自動追記 or 別列を増設（任意）。

> 標準UIは **CSSで非表示**（プラグインのパネルに完全置換）。

---

## 4. UI 仕様
- 配置：詳細画面の **右カラム上部**（なければ下部）にパネル挿入
- パネル構成：
  - ヘッダー：タイトル `進捗スクショ（N件）` + 「貼り付け」ボタン（フォーカス用）
  - コンテンツ：**2列グリッド** or **横スクロール**のいずれか（設定で切替）
  - アイテム：
    - サムネ（64〜96px、正方トリミング）
    - メモ（1行、ellipsis、クリックでインライン編集→保存）
    - 時刻表示（`YYYY-MM-DD HH:mm`）
- 挙動：
  - **Ctrl/⌘+V** → クリップボードの `image/*` を取得 → 圧縮 → `/k/v1/file` にアップロード → サブテーブルに **1行追記** → 再描画
  - **D&D**・**ファイル選択**も同ルーチンを共用
  - クリックでライトボックス拡大（簡易：新規タブ）
- 見た目：白ベース、薄いシャドウ、角丸、**“凝らない”**ミニマルデザイン
- 権限：編集不可ユーザーは追加 UI を非表示（閲覧のみ）

---

## 5. 設定項目（プラグイン設定画面）
- 対象 **サブテーブル** フィールドコード（初期値：`証拠`）
- サブテーブル内 **添付** フィールドコード（初期値：`画像`）
- サブテーブル内 **メモ** フィールドコード（初期値：`メモ`）
- UI レイアウト：`グリッド（2列） / 横スクロール` 切替
- 画像圧縮：ON/OFF、長辺px、品質（0.1〜1.0）
- メモ初期文言：例）`スクショ追加`
- 追加後の挙動：`即時再描画 / 成功トーストのみ`
- コメント自動投稿：ON/OFF、文言（例：`スクショを追加しました`）

---

## 6. 使用API / イベント
- イベント：`app.record.detail.show`
- アップロード：`POST /k/v1/file`（`FormData` + `__REQUEST_TOKEN__`）
- レコード取得：`GET /k/v1/record`（既存サブテーブル行の取得）
- レコード更新：`PUT /k/v1/record`（サブテーブルに **追記**）
- コメント（任意）：`POST /k/v1/record/comment`

---

## 7. 主要ロジック
1. detail.show でパネルを描画。標準サブテーブルDOMは CSS で非表示。
2. ペースト／D&D／選択 → `File` を取得。
3. 圧縮（必要時）→ `POST /file` で `fileKey` を得る。
4. `GET /record` → 既存サブテーブル配列に **`{ [画像]: fileKey, [メモ]: 初期文言 }`** を追加。
5. `PUT /record` で更新。
6. 再描画（件数反映・先頭に最新を表示）。

---

## 8. 非機能要件
- パフォーマンス：
  - 初期描画 < 200ms（サムネは遅延読み込み `loading="lazy"` 推奨）
  - 圧縮は WebWorker 不要（同期でもOK）だが、**1MB超の画像は圧縮**を基本ON
- 安定性：ブラウザは Chrome / Edge 最新、Safari（PC）準拠。**iOS のペースト制限**は既知（代替としてファイル選択ボタンを出す）。
- セキュリティ：
  - `__REQUEST_TOKEN__` を `FormData` に付与
  - APIトークンは**使用しない**（ログインユーザー権限で実行）
- アクセシビリティ：
  - キーボード操作で貼り付け可能（フォーカス可能なボタン設置）
  - 画像には `alt`（メモを利用）

---

## 9. エラーハンドリング
- アップロード失敗：トースト表示（`再試行` ボタン）
- PUT 失敗（権限など）：権限不足メッセージ（閲覧に切換）
- 画像以外のペースト：無視（サイレント）
- 過大サイズ：自動圧縮。圧縮失敗時は原寸アップロード or 中断（設定で選択）

---

## 10. 受け入れ基準（Acceptance Criteria）
- [ ] 詳細画面で **Ctrl/⌘+V → 3秒以内にサムネが表示** される
- [ ] 既存のサブテーブル行は保持され、**追記**される
- [ ] 標準サブテーブルUIは**視覚的に表示されない**
- [ ] 閲覧権限のみのユーザーは**追加操作が出ない**
- [ ] メモは**クリックでインライン編集**→Enterで保存
- [ ] 画像クリックで**拡大**（新規タブ or ライトボックス）
- [ ] 設定の**圧縮OFF**時は原寸で保存される
- [ ] iOS では貼り付け不可時に**代替の「ファイルを選ぶ」**が動作する

---

## 11. 実装メモ（擬似コード）
```js
kintone.events.on('app.record.detail.show', async () => {
  hideNativeSubtable();
  const id = kintone.app.record.getId();
  const mount = insertPanel();
  await renderGallery(id, mount);

  mount.addEventListener('paste', onPaste);
  mount.querySelector('[data-btn-select]').addEventListener('change', onFileSelect);
});

async function onPaste(e){ /* items -> file -> compress -> upload -> putRow -> render */ }
async function onFileSelect(e){ /* same routine */ }
```

---

## 12. CSS 指針（最小）
- 白背景、角丸 10px、薄いボーダー/シャドウ
- サムネ 64〜96px、`object-fit: cover`、丸角 6px
- 行はフレックス or グリッド、ギャップ 8px
- メモは `ellipsis`、フォーカス時に input に差し替え

---

## 13. ディレクトリ構成（例）
```
plugin/
  ├─ src/
  │   ├─ index.js        # 本体
  │   ├─ ui.css
  │   ├─ lightbox.js     # （任意）
  │   └─ config.html     # 設定UI
  ├─ manifest.json
  ├─ README.md
  └─ assets/
      └─ icon.webp
```

---

## 14. 将来拡張（Optional）
- 子アプリ（Evidence）への切替（データアクセス層差し替え）
- ステータス別タブ（あなたの既存「ビュータブ」プラグインと連携）
- コメント自動テンプレ、Slack通知、期限前リマインド
- 既読/未読風の軽いハイライト、最新N件のみ表示 + 「すべて表示」

---

## 15. 非対象（Out of Scope）
- 本格的なカンバンUI（列ドラッグ & ステータス連動）
- サーバーサイド／外部ストレージ連携
- OCR/画像解析などの付加機能

---

## 16. 参考フィールドコード（デフォルト）
- サブテーブル：`証拠`
  - 添付：`画像`
  - メモ：`メモ`

> プラグイン設定で変更可能。

---

## 17. バージョニング / 配布
- v0.1.0: A案実装（サブテーブル裏 + ギャラリー置換、貼り付け/圧縮/拡大/メモ編集）
- 配布：kintone プラグイン zip（`manifest.json`、`index.js`、`ui.css`、`config.html`、アイコン）

```

